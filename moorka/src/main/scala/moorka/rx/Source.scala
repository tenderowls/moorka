package moorka.rx

import moorka.rx.bindings.{Binding, OnceBinding}
import moorka.death.Reaper

/**
 * @author Aleksey Fomkin <aleksey.fomkin@gmail.com>
 */
trait Source[A] extends Rx[A] {

  private[moorka] var isAlive = true

  def alive: Boolean = isAlive

  /**
   * List of bindings generated by this source. When updated fired
   * all bindings will get a new value
   * @see [[flatMap]]
   */
  private[moorka] var bindings = List.empty[Binding[A]]

  /**
   * List of values this source depends on.
   */
  private[moorka] var upstreams = List.empty[Rx[_]]

  /**
   * Remove references to all upstreams that are not alive.
   */
  private[moorka] def cleanupUpstreams() = {
    upstreams = upstreams.filter(_.alive)
  }

  private[moorka] def addUpstream(x: Rx[_]): Unit = {
    upstreams ::= x
  }

  private[moorka] def killUpstreams() = {
    upstreams.foreach(_.kill())
    upstreams = Nil
  }

  /**
   * Broadcast `v` to bindings. Removes bindings dropped by GC.
   * @param v new value
   */
  private[moorka] def update(v: A, silent: Boolean = false): Unit = {
    if (isAlive && !silent) {
      bindings.foreach(_.run(v))
    }
  }

  private[moorka] def attachBinding(b: Binding[A]) = {
    bindings ::= b
  }

  private[moorka] def detachBinding(b: Binding[A]) = {
    bindings = bindings.filter(_ != b)
  }

  @inline def <<=(rx: Rx[A]): Unit = pull(rx)

  def pull(rx: Rx[A]): Unit = rx match {
    case Val(x) ⇒ update(x, silent = false)
    case Silent(some) ⇒ update(some, silent = true)
    case Killer ⇒ kill()
    case Dummy ⇒ // Do nothing
    case value ⇒
      val upstream = value.foreach(update(_, silent = false))
      addUpstream(upstream)
  }

  def pullOnce(rx: Rx[A]): Unit = rx once { data ⇒
    update(data)
  }

  override def once[U](f: (A) => U)(implicit reaper: Reaper): Rx[Unit] = {
    if (isAlive) {
      reaper.mark(new OnceBinding[A, U](this, f))
    }
    else {
      Dummy
    }
  }

  def kill(): Unit = {
    isAlive = false
    bindings = Nil
    killUpstreams()
  }
}

trait StatefulSource[A] extends Source[A]
